# ğŸ—ï¸ é¡¹ç›®æ¶æ„è¯´æ˜

## æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     æµè§ˆå™¨ (Client)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  ä¸»é¡µé¢          â”‚      â”‚  è¿æ¥è®¾ç½®         â”‚             â”‚
â”‚  â”‚  page.tsx       â”‚â—„â”€â”€â”€â”€â”€â”¤  ConnectionSettingsâ”‚            â”‚
â”‚  â”‚                 â”‚      â”‚                   â”‚             â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚  â”‚  â”‚Live2DåŒºåŸŸâ”‚  â”‚                                         â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                         â”‚
â”‚  â”‚                 â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚      â”‚  çŠ¶æ€ç®¡ç†         â”‚             â”‚
â”‚  â”‚  â”‚èŠå¤©ç•Œé¢  â”‚  â”‚â—„â”€â”€â”€â”€â”€â”¤  Zustand Store   â”‚             â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚      â”‚  - messages      â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚  - connection    â”‚             â”‚
â”‚          â–²                â”‚  - emotions      â”‚             â”‚
â”‚          â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚          â”‚                         â–²                        â”‚
â”‚          â”‚                         â”‚                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚         Realtime Service                  â”‚             â”‚
â”‚  â”‚  - OpenAI Realtime APIå°è£…                â”‚             â”‚
â”‚  â”‚  - WebSocketç®¡ç†                          â”‚             â”‚
â”‚  â”‚  - éŸ³é¢‘å¤„ç†                               â”‚             â”‚
â”‚  â”‚  - å£å‹åŒæ­¥                               â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                  â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”‚ WebSocket
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              OpenAI Realtime API                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚   ASR    â”‚â”€â–¶â”‚   LLM    â”‚â”€â–¶â”‚   TTS    â”‚                  â”‚
â”‚  â”‚ Whisper  â”‚  â”‚  GPT-4o  â”‚  â”‚  Voice   â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æŠ€æœ¯æ ˆè¯¦è§£

### å‰ç«¯å±‚ (Browser)

#### 1. UIæ¡†æ¶
```typescript
Next.js 15           // Reactå…ƒæ¡†æ¶ï¼Œæä¾›è·¯ç”±ã€SSRç­‰
  â”œâ”€ React 19        // UIç»„ä»¶åº“
  â”œâ”€ TypeScript 5.7  // ç±»å‹ç³»ç»Ÿ
  â””â”€ Tailwind CSS v4 // æ ·å¼æ¡†æ¶
```

#### 2. æ ¸å¿ƒç»„ä»¶

**ä¸»é¡µé¢** (`app/page.tsx`)
- æ•´ä½“å¸ƒå±€
- ç»„ä»¶ç¼–æ’
- å“åº”å¼è®¾è®¡

**Live2Dæ•°å­—äºº** (`components/Live2DCharacter.tsx`)
```typescript
PixiJS 8.6           // WebGLæ¸²æŸ“å¼•æ“
  â””â”€ Live2D SDK      // 2Dæ•°å­—äººæ¨¡å‹åŠ è½½å’Œæ§åˆ¶
     â”œâ”€ æ¨¡å‹æ¸²æŸ“
     â”œâ”€ è¡¨æƒ…æ§åˆ¶
     â”œâ”€ å£å‹åŒæ­¥
     â””â”€ åŠ¨ä½œæ’­æ”¾
```

**èŠå¤©ç•Œé¢** (`components/ChatInterface.tsx`)
```typescript
Framer Motion 12     // åŠ¨ç”»åº“
  â”œâ”€ æ¶ˆæ¯åˆ—è¡¨åŠ¨ç”»
  â”œâ”€ æŒ‰é’®äº¤äº’åé¦ˆ
  â””â”€ çŠ¶æ€è½¬æ¢åŠ¨ç”»
```

**è¿æ¥è®¾ç½®** (`components/ConnectionSettings.tsx`)
- APIå¯†é’¥é…ç½®
- è¿æ¥çŠ¶æ€ç®¡ç†
- é”™è¯¯å¤„ç†

#### 3. çŠ¶æ€ç®¡ç† (`lib/store.ts`)
```typescript
Zustand 5.0
  â”œâ”€ è¿æ¥çŠ¶æ€ (isConnected, isRecording, isSpeaking)
  â”œâ”€ æ¶ˆæ¯å†å² (messages[])
  â”œâ”€ æ•°å­—äººçŠ¶æ€ (emotion, mouthOpenness)
  â””â”€ Actions (setXXX, addMessage, etc.)
```

### æœåŠ¡å±‚

#### Realtime Service (`lib/realtime-service.ts`)

**æ ¸å¿ƒåŠŸèƒ½**:
```typescript
class RealtimeService {
  // 1. è¿æ¥ç®¡ç†
  connect(apiKey)              // å»ºç«‹WebSocketè¿æ¥
  disconnect()                 // æ–­å¼€è¿æ¥
  
  // 2. éŸ³é¢‘å¤„ç†
  startRecording()             // å¼€å§‹éº¦å…‹é£å½•éŸ³
  stopRecording()              // åœæ­¢å½•éŸ³
  handleAudioDelta(data)       // å¤„ç†AIè¿”å›çš„éŸ³é¢‘
  
  // 3. å£å‹åŒæ­¥
  analyzeAudioForLipSync()     // å®æ—¶åˆ†æéŸ³é¢‘æ§åˆ¶å£å‹
  
  // 4. æ¶ˆæ¯å‘é€
  sendText(text)               // å‘é€æ–‡æœ¬æ¶ˆæ¯
  interrupt()                  // æ‰“æ–­AIè¯´è¯
}
```

**äº‹ä»¶æµç¨‹**:
```
ç”¨æˆ·å½•éŸ³ â†’ MediaRecorder
         â†“
    base64ç¼–ç 
         â†“
    WebSocketå‘é€ â†’ OpenAI Realtime API
                           â†“
                    ASR (Whisper)
                           â†“
                    LLM (GPT-4o)
                           â†“
                    TTS (Voice)
                           â†“
    â† WebSocketæ¥æ”¶ â† éŸ³é¢‘æµ (base64)
         â†“
    è§£ç  + æ’­æ”¾
         â†“
    éŸ³é¢‘åˆ†æ â†’ æ§åˆ¶æ•°å­—äººå£å‹
```

### åç«¯APIå±‚

#### OpenAI Realtime API

**é…ç½®å‚æ•°**:
```typescript
{
  model: 'gpt-4o-realtime-preview',
  voice: 'alloy',                    // è¯­éŸ³ç±»å‹
  instructions: 'ç³»ç»Ÿæç¤ºè¯',          // AIäººæ ¼è®¾å®š
  input_audio_format: 'pcm16',       // éŸ³é¢‘æ ¼å¼
  output_audio_format: 'pcm16',
  turn_detection: {                  // è¯­éŸ³æ´»åŠ¨æ£€æµ‹
    type: 'server_vad',
    threshold: 0.5,
    silence_duration_ms: 500
  }
}
```

**ä¸»è¦äº‹ä»¶**:
- `conversation.item.input_audio_transcription.completed` - ç”¨æˆ·è¯­éŸ³è¯†åˆ«å®Œæˆ
- `response.text.delta` - AIæ–‡æœ¬å“åº”ç‰‡æ®µ
- `response.text.done` - AIæ–‡æœ¬å“åº”å®Œæˆ
- `response.audio.delta` - AIéŸ³é¢‘å“åº”ç‰‡æ®µï¼ˆç”¨äºå£å‹åŒæ­¥ï¼‰
- `response.audio.done` - AIéŸ³é¢‘å“åº”å®Œæˆ

## æ•°æ®æµ

### ç”¨æˆ·å‘é€æ¶ˆæ¯æµç¨‹

```
æ–‡æœ¬è¾“å…¥:
ç”¨æˆ·è¾“å…¥æ–‡å­— â†’ ChatInterface.tsx
              â†“
       store.addMessage(user)
              â†“
    realtimeService.sendText()
              â†“
       WebSocket.send()
              â†“
    OpenAI Realtime APIå¤„ç†
              â†“
       è¿”å›æ–‡æœ¬ + éŸ³é¢‘
              â†“
    store.addMessage(assistant)
              â†“
       UIæ›´æ–° + æ•°å­—äººè¯´è¯
```

```
è¯­éŸ³è¾“å…¥:
ç”¨æˆ·ç‚¹å‡»éº¦å…‹é£ â†’ realtimeService.startRecording()
                â†“
           MediaRecorderå½•éŸ³
                â†“
           æ¯100mså‘é€éŸ³é¢‘ç‰‡æ®µ
                â†“
           WebSocket.send(audioData)
                â†“
           ç”¨æˆ·ç‚¹å‡»åœæ­¢
                â†“
           createResponse() è§¦å‘AIå›å¤
                â†“
           (åŒä¸Šï¼Œè¿”å›éŸ³é¢‘)
```

### å£å‹åŒæ­¥æµç¨‹

```
AIè¿”å›éŸ³é¢‘ â†’ handleAudioDelta()
             â†“
        è§£ç base64
             â†“
        AudioContext.decodeAudioData()
             â†“
        åˆ›å»ºAnalyserNode
             â†“
        requestAnimationFrameå¾ªç¯
             â†“
        analyser.getByteFrequencyData()
             â†“
        è®¡ç®—å¹³å‡éŸ³é‡
             â†“
        å½’ä¸€åŒ– (0-1)
             â†“
        store.setMouthOpenness(value)
             â†“
        Live2DCharacterç›‘å¬stateå˜åŒ–
             â†“
        model.setParameter('ParamMouthOpenY', value)
             â†“
        æ•°å­—äººå˜´å·´åŠ¨èµ·æ¥ âœ¨
```

## æ€§èƒ½ä¼˜åŒ–ç‚¹

### 1. å‡å°‘å»¶è¿Ÿ
- âœ… ä½¿ç”¨æµå¼å¤„ç†ï¼ˆè¾¹ç”Ÿæˆè¾¹æ’­æ”¾ï¼‰
- âœ… WebSocketé•¿è¿æ¥ï¼ˆé¿å…HTTPæ¡æ‰‹ï¼‰
- âœ… éŸ³é¢‘åˆ†å—å‘é€ï¼ˆ100ms/å—ï¼‰
- âœ… æœåŠ¡ç«¯VADï¼ˆè‡ªåŠ¨æ£€æµ‹è¯´è¯ç»“æŸï¼‰

### 2. èµ„æºä¼˜åŒ–
- âœ… PixiJSèµ„æºå¤ç”¨
- âœ… åŠ¨æ€importå‡å°‘åˆå§‹åŒ…ä½“ç§¯
- âœ… æ‡’åŠ è½½Live2Dæ¨¡å‹
- âœ… éŸ³é¢‘æµå¼æ’­æ”¾ï¼ˆä¸ç­‰å…¨éƒ¨ä¸‹è½½ï¼‰

### 3. ç”¨æˆ·ä½“éªŒ
- âœ… LoadingçŠ¶æ€åé¦ˆ
- âœ… é”™è¯¯è¾¹ç•Œå¤„ç†
- âœ… ä¼˜é›…é™çº§ï¼ˆAPIå¤±è´¥æ—¶çš„æç¤ºï¼‰
- âœ… åŠ¨ç”»è¿‡æ¸¡ï¼ˆFramer Motionï¼‰

## æ‰©å±•ç‚¹

### æ·»åŠ æ–°çš„AIæœåŠ¡

åœ¨ `lib/` ä¸‹åˆ›å»ºæ–°çš„service:

```typescript
// lib/deepgram-service.ts
export class DeepgramService {
  async transcribe(audio) {
    // ASRå®ç°
  }
}

// lib/claude-service.ts
export class ClaudeService {
  async chat(text) {
    // LLMå®ç°
  }
}

// lib/cartesia-service.ts
export class CartesiaService {
  async synthesize(text) {
    // TTSå®ç°
  }
}
```

### æ·»åŠ æ–°çš„æ•°å­—äººæ¨¡å‹

```typescript
// components/VRMCharacter.tsx
import { VRMLoaderPlugin } from '@pixiv/three-vrm';

export default function VRMCharacter() {
  // 3Dæ•°å­—äººå®ç°
}
```

### æ·»åŠ æ–°åŠŸèƒ½

**ç¤ºä¾‹: è¡¨æƒ…è¯†åˆ«**
```typescript
// lib/emotion-detector.ts
export function detectEmotion(text: string): EmotionType {
  if (text.includes('å“ˆå“ˆ') || text.includes('ğŸ˜„')) {
    return 'happy';
  }
  // ... æ›´å¤šè§„åˆ™
  return 'neutral';
}

// åœ¨ realtime-service.ts ä¸­ä½¿ç”¨
const emotion = detectEmotion(responseText);
useDigitalHumanStore.getState().setEmotion(emotion);
```

## éƒ¨ç½²æ¶æ„

```
å¼€å‘ç¯å¢ƒ:
localhost:3000 â†’ Next.js Dev Server

ç”Ÿäº§ç¯å¢ƒ:
ç”¨æˆ·æµè§ˆå™¨
    â†“
Vercel Edge Network (CDN)
    â†“
Next.js æœåŠ¡å™¨ (Serverless)
    â†“
OpenAI Realtime API
```

## å®‰å…¨è€ƒè™‘

âš ï¸ **å½“å‰å®ç°** (ä»…ç”¨äºå¼€å‘):
- APIå¯†é’¥å­˜å‚¨åœ¨ `localStorage`
- ç›´æ¥åœ¨æµè§ˆå™¨è°ƒç”¨API

âœ… **ç”Ÿäº§ç¯å¢ƒåº”è¯¥**:
```
ç”¨æˆ·æµè§ˆå™¨
    â†“
ä½ çš„åç«¯æœåŠ¡å™¨ (ä¸­ç»§)
    â†“
OpenAI Realtime API
```

**å®ç°æ–¹å¼**:
```typescript
// app/api/realtime/route.ts
export async function POST(req: Request) {
  const { message } = await req.json();
  
  // æœåŠ¡ç«¯è°ƒç”¨OpenAI
  const response = await fetch('https://api.openai.com/v1/...', {
    headers: {
      'Authorization': `Bearer ${process.env.OPENAI_API_KEY}` // æœåŠ¡ç«¯å¯†é’¥
    }
  });
  
  return Response.json(response);
}
```

è¿™æ ·APIå¯†é’¥æ°¸è¿œä¸ä¼šæš´éœ²ç»™å®¢æˆ·ç«¯ã€‚

---

**æ€»ç»“**: è¿™æ˜¯ä¸€ä¸ªç°ä»£åŒ–ã€æ¨¡å—åŒ–çš„å®æ—¶äº’åŠ¨æ•°å­—äººæ¶æ„ï¼Œ
ä½¿ç”¨2025å¹´æœ€æ–°æŠ€æœ¯æ ˆï¼Œæ˜“äºç†è§£å’Œæ‰©å±•ã€‚
